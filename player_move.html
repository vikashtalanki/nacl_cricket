<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
        <link href="https://fonts.googleapis.com/css?family=Roboto Condensed" rel="stylesheet" />
        <style>
            .styled-table {
                border-collapse: collapse;
                margin: 25px 0;
                min-width: 400px;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
                border-style: hidden;
                font-family: "Roboto Condensed";
                font-size: 14px;
                transition: opacity 1s;
            }
            .styled-table th {
                cursor: pointer;
                padding: 15px 15px;
                border: 2px solid white;
            }
            .styled-table tr {
                color: #ffffff;
                text-align: left;
                background-color: #012169;
            }

            .styled-table td {
                padding: 5px 15px;
                border: 2px solid white;
            }

            .styled-table tr:first-child {
                background-color: #da291c;
            }

            .styled-table tbody tr {
                border-bottom: 1px solid #dddddd;
            }

            .styled-table tbody tr:nth-of-type(even) {
                background-color: #012169;
            }

            .styled-table tbody tr:last-of-type {
                border-bottom: 2px solid #012169;
            }

            #playersTableBody  {
                display: table;
                margin-right: auto;
                margin-left: auto;
                font-family: "Roboto Condensed";
                font-size: 14px;
            }

            #inputDiv,
            #playerInfoDiv {
                display: flex;
                align-items: center;
                justify-content: center;
                font-family: "Roboto Condensed";
                font-size: 14px;
            }

            .selectItems {
                border: 2px solid #012169;
                width: 160px;
                height: 32px;
                font-size: 14px;
                border-radius: 8px;
            }

            .playerInfoDivLabels {
                font-family: "Roboto Condensed";
                font-size: 16px;
            }

            .btn {
                background-color: #012169; /* Green */
                border: none;
                color: white;
                padding: 10px 32px;
                text-align: center;
                text-decoration: none;
                font-size: 14px;
                cursor: pointer;
                border-radius: 8px;
                margin-left :15px
            }
        </style>    
    </head>
    <body>
        <div id="initDiv">
            <div id="inputDiv">
                <select id="selSeries" class="selectItems">
                    <option value="">Select Series</option>
                </select>&nbsp;&nbsp;&nbsp;&nbsp;
                <select name="knownOptions" id="knownOptions" class="selectItems">
                    <option value="selectKnownOption">What I know</option>
                    <option value="playerTeam">Player Current Team</option>
                    <option value="playerId">Player Id</option>
                    <option value="playerName">Player Name</option>
                </select>
                <input type="button" style="display: none;" value="Submit" id="inputDivSubmit" class="btn" />
            </div><br>
            <div id="playerInfoDiv" style="display: none;">
                <label id="selTeamLabel" for="selTeam" style="display: none;" class="playerInfoDivLabels">Select Player Team:</label>&nbsp;&nbsp;&nbsp;&nbsp;
                <select id="selTeam" style="display: none;" class="selectItems"></select>
                <label id="playerIdLabel" for="playerIdInput" style="display: none;" class="playerInfoDivLabels">Input Player ID:</label>&nbsp;&nbsp;&nbsp;&nbsp;
                <input type="text" id="playerIdInput" name="playerIdInput" style="display: none;" class="selectItems">
                <label id="playerNameLabel" for="playerNameInput" style="display: none;" class="playerInfoDivLabels">Input Player Name:</label>&nbsp;&nbsp;&nbsp;&nbsp;
                <input type="text" id="playerNameInput" name="playerNameInput" style="display: none;" class="selectItems">
                <input type="button" style="display: none;" value="Submit" id="playerInfoDivSubmit" class="btn" />
            </div><br>
            <div id="playersTableBody"></div>
        </div>
    </body>
    <script>
        var selectedSeries = 0;
        var selectedSeriesName = "";
        var inputDivSelectedOption = "";
        var playersURL = "https://ccapi.cricclubs.com/CCAPI/team/getTeamPlayers?clubId=27594&teamId=";
        var teamMatchesUrl = "https://ccapi.cricclubs.com/CCAPI/match/getMatches?clubId=27594&seriesId=";
        var matchUrl = "https://ccapi.cricclubs.com/CCAPI/match/getMatchInfo?clubId=27594&v=4.0.412&X-Auth-Token=6a768e47-dc6a-4eef-96c3-5ed7eedfd282&matchId=";
        const seriesToDivMap = new Map();//Map<series, List<divIds>>
        const teamIdToNameMap = new Map();//Map<teamId, teamName>
        $(document).ready(function () {
            $("#selSeries").html("");
            $("#playersTableBody").html("");
            $("#selSeries").append('<option value="">Select Season</option>');
            var seriesListURL = "https://ccapi.cricclubs.com/CCAPI/series/getSeriesList?clubId=27594";
            var seriesDetailsURL = "https://ccapi.cricclubs.com/CCAPI/series/getSeriesDetails?clubId=27594&X-Auth-Token=6a768e47-dc6a-4eef-96c3-5ed7eedfd282&seriesId=";
            $.getJSON(seriesListURL, function (data) {
                $.each(data.data.seriesList, function (index, series) {
                    var seriesId = series.seriesID;
                    var seriesName = series.seriesName
                    if(series.parentSeriesId == 0) {// show only parent series
                        $("#selSeries").append('<option value="' + seriesId + '">' + seriesName + "</option>");
                    }
                    $.getJSON(seriesDetailsURL+seriesId, function (data1) {
                        seriesToDivMap.set(seriesId,[]);
                        if(data1.data.hasDivisions) {
                            $.each(data1.data.divisions, function (index, divs) {
                                seriesToDivMap.get(seriesId).push(divs.leagueId);
                            });
                        }
                        else
                            seriesToDivMap.get(seriesId).push(seriesId);
                    });
                });
            });
        });
        var body = document.getElementById("playersTableBody");
        $("#inputDivSubmit").show();
        $("#inputDivSubmit").click(function () {
            $("#playersTableBody").html("");
            var teamsCalls = [];
            selectedSeries = $('#selSeries :selected').val();
            selectedSeriesName = $('#selSeries :selected').text();
            const url = "https://ccapi.cricclubs.com/CCAPI/team/getTeamsList?clubId=27594&seriesId=";
            seriesToDivMap.get(parseInt(selectedSeries)).forEach((divId) => 
                teamsCalls.push($.getJSON(url+divId, function (data) {
                    $.each(data.data.teamsList, function (index, value) {
                        $.each(value.teams, function (index, value) {
                            teamIdToNameMap.set(value.teamID,value.teamName);
                        });
                    });
                }))
            );
            $.when.apply($,teamsCalls).then(function() {
                $("#selTeam").html("");
                $("#selTeamLabel").hide();
                $("#selTeam").hide();
                $("#playerIdInput").html("");
                $("#playerIdLabel").hide();
                $("#playerIdInput").hide();
                $("#playerNameInput").html("");
                $("#playerNameLabel").hide();
                $("#playerNameInput").hide();
                $("#playerInfoDiv").show();
                inputDivSelectedOption = $('#knownOptions :selected').val();
                if ( inputDivSelectedOption == "playerTeam") {
                    
                    $("#selTeam").html("");
                    $("#selTeam").append('<option value="">Select...</option>');
                    $("#selTeamLabel").show();
                    $("#selTeam").show();
                    //console.log(teamIdToNameMap);
                    teamIdToNameMap.forEach((value, key) => {
                        $("#selTeam").append('<option value="' + key + '">' + value + "</option>");
                    })
                }
                if ( inputDivSelectedOption == "playerId") {
                    $("#playerIdLabel").show();
                    $("#playerIdInput").show();
                }
                if ( inputDivSelectedOption == "playerName") {
                    $("#playerNameLabel").show();
                    $("#playerNameInput").show();
                }
            });
        });
        $("#playerInfoDivSubmit").show();
        $("#playerInfoDivSubmit").click(function () {
            //var teamToPlayerMap = prepareTeamToPlayerMap(selectedSeries);
            var playersMatchCountMap = new Map();

            $("#playersTableBody").html("");
            var tbl = document.createElement("table");
            tbl.setAttribute("class", "styled-table");
            tbl.setAttribute("style","table-layout:fixed");
            tbl.setAttribute("id", "playerDetailsTable");
            
            var tr = document.createElement('tr');

            var trsno = document.createElement('th');
            trsno.appendChild(document.createTextNode("S.No."));
            tr.appendChild(trsno);

            var trplayerId = document.createElement('th');
            trplayerId.appendChild(document.createTextNode("Player Id"));
            tr.appendChild(trplayerId);

            var trplayerName = document.createElement('th');
            trplayerName.appendChild(document.createTextNode("Player Name"));
            tr.appendChild(trplayerName);

            var trteam = document.createElement('th');
            trteam.appendChild(document.createTextNode("Current Team"));
            tr.appendChild(trteam);

            var trmove = document.createElement('th');
            trmove.appendChild(document.createTextNode("Move To"));
            tr.appendChild(trmove);

            var movebtn = document.createElement('th');
            movebtn.appendChild(document.createTextNode(""));
            tr.appendChild(movebtn);
            
            tbl.appendChild(tr);
            body.insertBefore(tbl, body.firstChild);

            var matchesCalls=[];
            var matchCalls=[];
            if (inputDivSelectedOption == "playerTeam") {
                var snoCount = 1;
                var selectedTeam = $('#selTeam :selected').val();
                var selectedTeamName = $('#selTeam :selected').text();
                
                seriesToDivMap.get(parseInt(selectedSeries)).forEach((divId) =>
                    matchesCalls.push($.getJSON(teamMatchesUrl+divId+"&teamId="+selectedTeam, function (data) {
                        $.each(data.data, function (idx, matchVal) {
                            matchCalls.push($.getJSON(matchUrl+matchVal.matchId, function (matchData) {
                                if(matchData.data.teamOne == selectedTeam) {
                                    $.each(matchData.data.team1Players, function (idx, playerStat) {
                                        if(!playersMatchCountMap.has(playerStat.playerID))
                                            playersMatchCountMap.set(playerStat.playerID, 0);
                                        playersMatchCountMap.set(playerStat.playerID, playersMatchCountMap.get(playerStat.playerID)+1);
                                    });
                                }
                                else if(matchData.data.teamTwo == selectedTeam) {
                                    $.each(matchData.data.team2Players, function (idx, playerStat) {
                                        if(!playersMatchCountMap.has(playerStat.playerID))
                                            playersMatchCountMap.set(playerStat.playerID, 0);
                                        playersMatchCountMap.set(playerStat.playerID, playersMatchCountMap.get(playerStat.playerID)+1);
                                    });
                                }
                            }))
                        })
                    })) 
                );
                $.when.apply($,matchesCalls).then(function() {
                    $.when.apply($,matchCalls).then(function() {
                        console.log(playersMatchCountMap)
                        $.getJSON(playersURL+selectedTeam, function (data) {
                            $.each(data.data.teamPlayers, function (index, value) {
                                if(!playersMatchCountMap.has(value.playerID)) {
                                    fillTable(snoCount, value.playerID, value.firstName + " " + value.lastName, selectedTeamName);
                                    snoCount += 1;
                                }
                            });
                        });
                    });
                });
            }
            else if(inputDivSelectedOption == "playerId") {
                var givenPlayerId = document.querySelector('#playerIdInput').value;
                teamIdToNameMap.forEach((team, teamId) => {
                    $.getJSON(playersURL+teamId, function (data) {
                        $.each(data.data.teamPlayers, function (index, player) {
                            if(givenPlayerId == player.playerID) {
                                var playerMatchCount = 0;
                                seriesToDivMap.get(parseInt(selectedSeries)).forEach((divId) =>
                                    matchesCalls.push($.getJSON(teamMatchesUrl+divId+"&teamId="+teamId, function (data) {
                                        $.each(data.data, function (idx, matchVal) {
                                            matchCalls.push($.getJSON(matchUrl+matchVal.matchId, function (matchData) {
                                                if(matchData.data.teamOne == teamId) {
                                                    $.each(matchData.data.team1Players, function (idx, playerStat){
                                                            if(playerStat.playerID == givenPlayerId)
                                                                playerMatchCount += 1;
                                                        }
                                                    );
                                                }
                                                else if(matchData.data.teamTwo == teamId) {
                                                    $.each(matchData.data.team2Players, function (idx, playerStat){
                                                            if(playerStat.playerID == givenPlayerId)
                                                                playerMatchCount += 1;
                                                        }
                                                    );
                                                }
                                            }))
                                        })
                                    })) 
                                );
                                $.when.apply($,matchesCalls).then(function() {
                                    $.when.apply($,matchCalls).then(function() {
                                        console.log(playerMatchCount)
                                        if(playerMatchCount == 0)
                                            fillTable(1, player.playerID, player.firstName + " " + player.lastName, team);
                                    });
                                });
                            }
                        });
                    });
                })
            }
        });
        function enableMoveButton(idx) {
            if(document.getElementById("moveToList-"+idx).value != "select")
                document.getElementById("movebtnId-"+idx).disabled=false;
            else
                document.getElementById("movebtnId-"+idx).disabled=true;

        }

        function moveTeams(idx, playerId, currentTeam) {
            var newTeam = $('#moveToList-'+idx+' :selected').text();
            console.log("Moving "+playerId+" from "+currentTeam+" to "+newTeam);
        }

        function fillTable(sno, playerId, playerName, playerCurrentTeam) {
            var tbl = document.getElementById("playerDetailsTable");
            var dr = tbl.insertRow();

            var snotc = document.createElement("Label");
            snotc.innerHTML = sno;
            dr.insertCell().appendChild(snotc);
            

            var playerIdtc = document.createElement("Label");
            playerIdtc.innerHTML = playerId;
            dr.insertCell().appendChild(playerIdtc);

            var playerNametc = document.createElement("Label");
            playerNametc.innerHTML = playerName;
            dr.insertCell().appendChild(playerNametc);

            var teamtc = document.createElement("Label");
            teamtc.innerHTML = playerCurrentTeam;
            dr.insertCell().appendChild(teamtc);

            var moveToListtc = document.createElement("select");
            moveToListtc.setAttribute("id", "moveToList-" + sno);
            moveToListtc.setAttribute("class", "selectItems");
            moveToListtc.setAttribute("onChange", "enableMoveButton("+sno+")");
            var moveToDefaultOption = document.createElement('option');
            moveToDefaultOption.value =  "select";
            moveToDefaultOption.text = "select";
            moveToListtc.appendChild(moveToDefaultOption);
            teamIdToNameMap.forEach((value, key) => {
                var moveToOption = document.createElement('option');
                moveToOption.value =  key;
                moveToOption.text = value;
                moveToListtc.appendChild(moveToOption);
            })
            dr.insertCell().appendChild(moveToListtc);

            var movebtntc = document.createElement('input');
            movebtntc.type = "button";
            movebtntc.className = "movebtn";
            movebtntc.value = "Move";
            movebtntc.id = "movebtnId-"+sno;
            movebtntc.setAttribute("onclick", "moveTeams("+sno+","+playerId+",\""+playerCurrentTeam+"\")");
            movebtntc.disabled = true;
            dr.insertCell().appendChild(movebtntc);
        }

        /*function prepareTeamToPlayerMap(series) {
            const teamToPlayerMap = new Map();
            var matchesCalls=[];
            var matchCalls=[];
            var playerCalls = [];
            teamIdToNameMap.forEach((teamName, teamId) => {
                teamToPlayerMap.set(teamId, new Map());
                playerCalls.push($.getJSON(playersURL+teamId, function (data) {
                    $.each(data.data.teamPlayers, function (index, player) {
                        teamToPlayerMap.get(teamId).set(player.playerID, [{playerId: player.playerID, playerName: player.firstName + " " + player.lastName, matchesPlayed: 0}]);
                    })
                }))
            });
            $.when.apply($,playerCalls).then(function() {
                alert("hi");
                seriesToDivMap.get(parseInt(series)).forEach((divId) =>
                    teamIdToNameMap.forEach((teamName, teamId) => {
                        matchesCalls.push($.getJSON(teamMatchesUrl+divId+"&teamId="+teamId, function (data) {
                            $.each(data.data, function (idx, matchVal) {
                                matchCalls.push($.getJSON(matchUrl+matchVal.matchId, function (matchData) {
                                    if(matchData.data.teamOne == teamName) {
                                        $.each(matchData.data.team1Players, function (idx, playerStat) {
                                            var currentMatchesPlayed = teamToPlayerMap.get(teamId).get(playerStat.playerID).matchesPlayed;
                                            teamToPlayerMap.get(teamId).get(playerStat.playerID).matchesPlayed = currentMatchesPlayed+1;
                                        });
                                    }
                                    else if(matchData.data.teamTwo == teamName) {
                                        $.each(matchData.data.team2Players, function (idx, playerStat) {
                                            var currentMatchesPlayed = teamToPlayerMap.get(teamId).get(playerStat.playerID).matchesPlayed;
                                            teamToPlayerMap.get(teamId).get(playerStat.playerID).matchesPlayed = currentMatchesPlayed+1;
                                        });
                                    }
                                }))
                            })
                        }))
                    })
                );
                $.when.apply($,matchesCalls).then(function() {
                    $.when.apply($,matchCalls).then(function() {
                        alert("hello");
                        console.log(teamToPlayerMap)
                        return teamToPlayerMap;
                    });
                });
            });
        }*/
    </script>
</html>